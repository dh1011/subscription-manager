name: API Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Image
      run: docker build -t subscription-manager .

    - name: Run Container
      run: |
        docker run -d --rm -p 3000:3000 --name subscription-manager-ci subscription-manager
        echo "Waiting for container to initialize..."
        sleep 10

    - name: Run API Tests
      run: |
        # Use the test-api script directly with BASE_URL
        export BASE_URL=http://localhost:3000
        # Install dependencies for the test script (if any are needed outside Docker, 
        # but the script uses native fetch so just node is needed. 
        # However, we need to make sure we have a node environment to run the script)
        npm run test:api
